const fs = require('fs');
const path = require('path');

// Scans components/** for *.stories.(js|jsx|ts|tsx) and generates storybook/entries.js
const root = path.resolve(__dirname, '..');
const componentsDir = path.join(root, 'components');
const outFile = path.join(root, 'storybook', 'entries.js');

function walk(dir) {
  let results = [];
  const list = fs.readdirSync(dir);
  list.forEach((file) => {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);
    if (stat && stat.isDirectory()) {
      results = results.concat(walk(filePath));
    } else {
      if (/\.stories\.(js|jsx|ts|tsx)$/.test(file)) results.push(filePath);
    }
  });
  return results;
}

const stories = walk(componentsDir).map((p) => path.relative(path.join(root, 'storybook'), p).replace(/\\/g, '/'));

const modules = stories.map((relPath, idx) => {
  const key = `./story_${idx}`;
  return `  '${key}': require('${relPath}')`;
});

const content = `// Auto-generated by scripts/generate-story-entries.js
module.exports = {
  modules: {
${modules.join(',\n')}
  }
};
`;

fs.mkdirSync(path.dirname(outFile), { recursive: true });
fs.writeFileSync(outFile, content, 'utf8');
console.log(`Wrote ${outFile} with ${stories.length} stories.`);
